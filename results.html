<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results ‚Äî findyl</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="theme-color" content="#FF6B6B">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4VKXNETWR4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4VKXNETWR4');
    </script>
    
    <!-- DM Serif Text Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text:ital@0;1&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .dm-serif {
            font-family: 'DM Serif Text', serif;
        }
        
        h1, h2, h3 {
            font-family: 'DM Serif Text', serif;
        }
        
        .vinyl-card {
            transition: all 0.3s ease;
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Stagger animation for cards */
        .vinyl-card:nth-child(1) { animation-delay: 0.05s; }
        .vinyl-card:nth-child(2) { animation-delay: 0.1s; }
        .vinyl-card:nth-child(3) { animation-delay: 0.15s; }
        .vinyl-card:nth-child(4) { animation-delay: 0.2s; }
        .vinyl-card:nth-child(5) { animation-delay: 0.25s; }
        .vinyl-card:nth-child(6) { animation-delay: 0.3s; }
        .vinyl-card:nth-child(7) { animation-delay: 0.35s; }
        .vinyl-card:nth-child(8) { animation-delay: 0.4s; }
        
        .vinyl-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .store-button {
            transition: all 0.2s ease;
        }
        
        .store-button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .album-cover {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Spinning vinyl record animation */
        @keyframes spin-vinyl {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .vinyl-spinning {
            animation: spin-vinyl 2s linear infinite;
            display: inline-block;
        }
        
        .search-loading {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .search-loading.active {
            display: block;
        }
        
        .stores-expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in-out;
        }
        
        .stores-collapsed {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        
        /* Autocomplete dropdown */
        .autocomplete-container {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .autocomplete-dropdown.show {
            display: block;
        }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        
        .autocomplete-item:hover {
            background-color: #fef2f2;
        }
        
        .autocomplete-item strong {
            color: #FF6B6B;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <a href="index.html" class="flex items-center gap-2">
                    <div style="background-color: #FF6B6B; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <circle cx="10" cy="10" r="9.5" fill="none" stroke="white" stroke-width="0.5"/>
                          <circle cx="10" cy="10" r="7.5" fill="none" stroke="white" stroke-width="0.3" opacity="0.6"/>
                          <circle cx="10" cy="10" r="5.5" fill="none" stroke="white" stroke-width="0.3" opacity="0.6"/>
                          <circle cx="10" cy="10" r="3" fill="white"/>
                          <circle cx="10" cy="10" r="1" fill="#FF6B6B"/>
                        </svg>
                    </div>
                    <span class="text-2xl font-normal dm-serif" style="color: #1a1a1a;">findyl</span>
                </a>
                <form action="results.html" method="get" class="flex-1 max-w-2xl autocomplete-container">
                    <input 
                        type="text" 
                        name="q"
                        id="headerSearch"
                        placeholder="Search for artist or album..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2"
                        style="outline-color: #FF6B6B;"
                        autocomplete="off"
                    >
                    <div id="headerAutocomplete" class="autocomplete-dropdown"></div>
                </form>
                <nav class="flex gap-4 text-sm">
                    <a href="local-stores.html" class="text-gray-600 hover:text-gray-900">Stores</a>
                    <a href="about.html" class="text-gray-600 hover:text-gray-900">About</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl md:text-4xl font-normal mb-2" id="searchTitle">Searching...</h1>
            <p class="text-gray-600" id="searchSubtitle">Finding vinyl records for you</p>
        </div>

        <!-- Sort Controls -->
        <div id="sortControls" class="mb-6 flex items-center justify-between" style="display: none;">
            <p class="text-sm text-gray-600" id="resultCount"></p>
            <div class="flex items-center gap-2">
                <label for="sortSelect" class="text-sm text-gray-600">Sort by:</label>
                <select id="sortSelect" onchange="sortResults()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2" style="outline-color: #FF6B6B;">
                    <option value="relevance">Relevance</option>
                    <option value="year-desc">Release Date (Newest)</option>
                    <option value="year-asc">Release Date (Oldest)</option>
                    <option value="price-asc">Price (Low to High)</option>
                    <option value="price-desc">Price (High to Low)</option>
                    <option value="artist-asc">Artist (A-Z)</option>
                    <option value="artist-desc">Artist (Z-A)</option>
                    <option value="album-asc">Album (A-Z)</option>
                    <option value="album-desc">Album (Z-A)</option>
                </select>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="vinyl-spinning mb-4" style="font-size: 80px; line-height: 1;">
                <svg width="80" height="80" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="20" cy="20" r="19" fill="#FF6B6B"/>
                  <circle cx="20" cy="20" r="18" fill="none" stroke="white" stroke-width="0.5"/>
                  <circle cx="20" cy="20" r="15" fill="none" stroke="white" stroke-width="0.3" opacity="0.6"/>
                  <circle cx="20" cy="20" r="12" fill="none" stroke="white" stroke-width="0.3" opacity="0.6"/>
                  <circle cx="20" cy="20" r="9" fill="none" stroke="white" stroke-width="0.3" opacity="0.6"/>
                  <circle cx="20" cy="20" r="6" fill="white"/>
                  <circle cx="20" cy="20" r="2.5" fill="#FF6B6B"/>
                </svg>
            </div>
            <p class="text-gray-600">Searching vinyl database...</p>
        </div>

        <!-- Results -->
        <div id="vinylResults" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6" style="display: none;"></div>

        <!-- No Results -->
        <div id="noResults" style="display: none;" class="text-center py-12">
            <p class="text-xl text-gray-600 mb-4">No vinyl found for your search</p>
            <p class="text-sm text-gray-500">Try a different artist or album name</p>
        </div>

        <!-- Info Section -->
        <div class="mt-12 bg-blue-50 rounded-lg p-6">
            <h3 class="text-lg font-normal mb-2">How findyl Works</h3>
            <ul class="space-y-2 text-gray-700 text-sm">
                <li>‚úì Search our database of millions of vinyl releases</li>
                <li>‚úì Browse albums with cover art and details</li>
                <li>‚úì Click "Find Retailers" to see where to buy</li>
                <li>‚úì Choose from 20 UK stores - indie and major retailers</li>
            </ul>
        </div>
    </main>

    <footer class="mt-16 py-8 border-t border-gray-200">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
            <p class="mb-2">findyl may earn commission from purchases made through our links.</p>
            <p>Powered by Discogs ‚Ä¢ Supporting UK vinyl retailers since 2025</p>
        </div>
    </footer>

    <script>
        const params = new URLSearchParams(window.location.search);
        const searchQuery = params.get('q') || '';
        
        const stores = [
            {name: 'POP Store', url: 'https://www.awin1.com/cread.php?awinmid=118493&awinaffid=2772514&ued=https://www.wearepopstore.com/search?q=', domain: 'wearepopstore.com'},
            {name: 'Rough Trade', url: 'https://www.roughtrade.com/search?q=', domain: 'roughtrade.com'},
            {name: 'HMV', url: 'https://www.hmv.com/store/music/vinyl?text=', domain: 'hmv.com'},
            {name: 'Juno Records', url: 'https://www.juno.co.uk/search/?q%5Ball%5D%5B%5D=', domain: 'juno.co.uk'},
            {name: 'Amazon UK', url: 'https://www.amazon.co.uk/s?k=', domain: 'amazon.co.uk'},
            {name: 'Banquet Records', url: 'https://www.banquetrecords.com/search?q=', domain: 'banquetrecords.com'},
            {name: 'Zavvi', url: 'https://www.zavvi.com/search?q=', domain: 'zavvi.com'},
            {name: 'Rarewaves', url: 'https://www.rarewaves.com/search?q=', domain: 'rarewaves.com'},
            {name: 'Norman Records', url: 'https://www.normanrecords.com/search?q=', domain: 'normanrecords.com'},
            {name: 'Assai Records', url: 'https://assai.co.uk/page/1/?s=', domain: 'assai.co.uk'},
            {name: 'Monorail Music', url: 'https://www.monorailmusic.com/?s=', domain: 'monorailmusic.com'},
            {name: 'Resident Music', url: 'https://www.resident-music.com/search?q=', domain: 'resident-music.com'},
            {name: 'Piccadilly Records', url: 'https://www.piccadillyrecords.com/search?q=', domain: 'piccadillyrecords.com'},
            {name: 'Record Store', url: 'https://recordstore.co.uk/search?q=', domain: 'recordstore.co.uk'},
            {name: 'Sounds Like Vinyl', url: 'https://soundslikevinyl.com/search?q=', domain: 'soundslikevinyl.com'},
            {name: 'The Sound of Vinyl', url: 'https://thesoundofvinyl.com/search?q=', domain: 'thesoundofvinyl.com'},
            {name: 'Merchbar', url: 'https://www.merchbar.com/search?q=', domain: 'merchbar.com'},
            {name: 'EMP', url: 'https://www.emp.co.uk/search/?q=', domain: 'emp.co.uk'},
            {name: 'Vinyl Castle', url: 'https://www.vinylcastle.com/search?q=', domain: 'vinylcastle.com'},
            {name: 'Lost in Vinyl', url: 'https://www.lostinvinyl.org/page/1/?s=', domain: 'lostinvinyl.org'}
        ];

        // Update page title
        if (searchQuery) {
            document.getElementById('searchTitle').textContent = 'Vinyl records for "' + searchQuery + '"';
            document.getElementById('headerSearch').value = searchQuery;
        }

        // Search via our hybrid API endpoint (POPSTORE + Discogs)
        async function searchVinyl(query) {
            try {
                const response = await fetch('/api/hybrid-search?q=' + encodeURIComponent(query));
                
                if (!response.ok) {
                    throw new Error('API error');
                }
                
                const data = await response.json();
                console.log('Hybrid search results:', data);
                return data.results || [];
            } catch (error) {
                console.error('Error fetching vinyl:', error);
                return [];
            }
        }

        // Toggle store visibility for a vinyl card
        function toggleStores(cardId) {
            const storesDiv = document.getElementById('stores-' + cardId);
            const button = document.getElementById('btn-' + cardId);
            
            if (storesDiv.classList.contains('stores-collapsed')) {
                storesDiv.classList.remove('stores-collapsed');
                storesDiv.classList.add('stores-expanded');
                button.textContent = 'Hide Retailers';
            } else {
                storesDiv.classList.remove('stores-expanded');
                storesDiv.classList.add('stores-collapsed');
                button.textContent = 'Find Retailers';
            }
        }

        // Track clicks
        function trackStoreClick(storeName, albumTitle) {
            if (window.gtag) {
                gtag('event', 'store_click', {
                    'store_name': storeName,
                    'album_title': albumTitle,
                    'search_query': searchQuery
                });
            }
        }

        // Display results with POPSTORE prices
        function displayResults(results) {
            const container = document.getElementById('vinylResults');
            document.getElementById('loadingState').style.display = 'none';
            
            console.log('displayResults called with:', results.length, 'results');
            console.log('First result:', results[0]);
            
            if (results.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                document.getElementById('searchSubtitle').textContent = 'No results found';
                return;
            }
            
            container.style.display = 'grid';
            
            // Count results with buy options
            const resultsWithPrices = results.filter(r => r.buyOptions && r.buyOptions.length > 0).length;
            const totalBuyOptions = results.reduce((sum, r) => sum + (r.buyOptions ? r.buyOptions.length : 0), 0);
            
            if (resultsWithPrices > 0) {
                document.getElementById('searchSubtitle').textContent = `Found ${results.length} albums (${totalBuyOptions} buy options from UK retailers)`;
            } else {
                document.getElementById('searchSubtitle').textContent = `Found ${results.length} albums`;
            }
            
            let html = '';
            results.forEach((item, index) => {
                const hasBuyOptions = item.buyOptions && item.buyOptions.length > 0;
                
                html += '<div class="vinyl-card bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200">';
                html += '<img src="' + item.cover + '" alt="' + item.album + '" class="album-cover" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22300%22%3E%3Crect fill=%22%23667eea%22 width=%22300%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-size=%2248%22 fill=%22white%22%3Eüíø%3C/text%3E%3C/svg%3E\'">';
                html += '<div class="p-4">';
                html += '<h3 class="font-normal text-base mb-1 line-clamp-1">' + item.artist + '</h3>';
                html += '<p class="text-sm text-gray-600 mb-1 line-clamp-1">' + item.album + '</p>';
                
                // Show year if available
                if (item.year) {
                    html += '<p class="text-xs text-gray-500 mb-2">' + item.year + '</p>';
                }
                
                // If we have buy options, show them all
                if (hasBuyOptions) {
                    // Show "From ¬£X.XX" if multiple options
                    if (item.buyOptions.length > 1) {
                        const priceNum = typeof item.price === 'number' ? item.price : parseFloat(item.price);
                        html += '<p class="text-lg font-bold mb-3" style="color: #FF6B6B;">From ¬£' + priceNum.toFixed(2) + '</p>';
                    } else {
                        const priceNum = typeof item.buyOptions[0].price === 'number' ? item.buyOptions[0].price : parseFloat(item.buyOptions[0].price);
                        html += '<p class="text-lg font-bold mb-2" style="color: #FF6B6B;">¬£' + priceNum.toFixed(2) + '</p>';
                    }
                    
                    // Show buy button for each option (sorted by price, cheapest first)
                    item.buyOptions.forEach(option => {
                        const priceNum = typeof option.price === 'number' ? option.price : parseFloat(option.price);
                        const isInStock = option.availability && (option.availability === 'In Stock' || option.availability === 'in_stock');
                        const stockBadge = isInStock ? '<span style="color: #10B981; font-size: 11px;">‚úì In Stock</span>' : '';
                        
                        // Get retailer favicon/logo
                        let retailerDomain = '';
                        if (option.source === 'popstore') {
                            retailerDomain = 'popstore.co.uk';
                        } else if (option.source === 'vinylcastle') {
                            retailerDomain = 'vinylcastle.com';
                        }
                        const faviconUrl = retailerDomain ? 'https://www.google.com/s2/favicons?domain=' + retailerDomain + '&sz=64' : '';
                        
                        html += '<a href="' + option.link + '" target="_blank" rel="noopener noreferrer" class="block w-full py-3 px-4 text-center font-medium rounded-lg mb-2 transition-all hover:shadow-md" style="background-color: white; border: 2px solid #FF6B6B; color: #1F2937;">';
                        html += '<div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">';
                        
                        // Left side: Logo + Store name
                        html += '<div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">';
                        if (faviconUrl) {
                            html += '<img src="' + faviconUrl + '" alt="' + option.storeName + '" style="width: 20px; height: 20px; flex-shrink: 0;" onerror="this.style.display=\'none\'">';
                        }
                        html += '<span style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + option.storeName + '</span>';
                        html += '</div>';
                        
                        // Right side: Price + Stock
                        html += '<div style="display: flex; flex-direction: column; align-items: flex-end; gap: 2px;">';
                        html += '<span style="font-weight: 700; color: #FF6B6B; font-size: 16px;">¬£' + priceNum.toFixed(2) + '</span>';
                        if (stockBadge) {
                            html += stockBadge;
                        }
                        html += '</div>';
                        
                        html += '</div>';
                        html += '</a>';
                    });
                    
                    html += '<button onclick="toggleStores(' + index + ')" id="btn-' + index + '" class="w-full py-2 px-4 text-gray-700 font-medium rounded-lg border border-gray-300 text-sm hover:bg-gray-50 transition-all">Or find at other retailers</button>';
                } else if (item.discogs_url) {
                    // Discogs-only album
                    html += '<p class="text-xs text-gray-500 mb-3">' + item.format + '</p>';
                    html += '<a href="' + item.discogs_url + '" target="_blank" rel="noopener noreferrer" class="block w-full py-2 px-4 text-center text-white font-medium rounded-lg mb-2 transition-all hover:opacity-90" style="background-color: #FF6B6B;">View on Discogs</a>';
                    html += '<button onclick="toggleStores(' + index + ')" id="btn-' + index + '" class="w-full py-2 px-4 text-gray-700 font-medium rounded-lg border border-gray-300 text-sm">Find at retailers</button>';
                } else {
                    // Show Discogs marketplace price if available
                    if (item.price && item.price_source === 'discogs_marketplace') {
                        const priceNum = typeof item.price === 'number' ? item.price : parseFloat(item.price);
                        html += '<p class="text-sm text-gray-600 mb-1">From <span class="font-bold" style="color: #FF6B6B;">¬£' + priceNum.toFixed(2) + '</span> on Discogs marketplace</p>';
                    }
                    
                    // Show format/year if from Discogs
                    html += '<p class="text-xs text-gray-500 mb-3">' + (item.year ? item.year + ' ‚Ä¢ ' : '') + item.format + '</p>';
                    
                    // Different button text based on whether we have Discogs price
                    if (item.discogs_url) {
                        html += '<a href="' + item.discogs_url + '" target="_blank" rel="noopener noreferrer" class="block w-full py-2 px-4 text-center text-white font-medium rounded-lg mb-2 transition-all hover:opacity-90" style="background-color: #FF6B6B;">View on Discogs</a>';
                        html += '<button onclick="toggleStores(' + index + ')" id="btn-' + index + '" class="w-full py-2 px-4 text-gray-700 font-medium rounded-lg border border-gray-300 text-sm">Or find at retailers</button>';
                    } else {
                        html += '<button onclick="toggleStores(' + index + ')" id="btn-' + index + '" class="w-full py-2 px-4 text-white font-medium rounded-lg transition-all hover:opacity-90" style="background-color: #FF6B6B;">Find Retailers</button>';
                    }
                }
                
                // Always-visible quick links to top retailers
                const searchTerm = item.artist + ' ' + item.album;
                const topStores = [
                    {name: 'Rough Trade', url: 'https://www.roughtrade.com/search?q=', domain: 'roughtrade.com'},
                    {name: 'Banquet', url: 'https://www.banquetrecords.com/search?q=', domain: 'banquetrecords.com'},
                    {name: 'Juno', url: 'https://www.juno.co.uk/search/?q%5Ball%5D%5B%5D=', domain: 'juno.co.uk'},
                    {name: 'Recordstore', url: 'https://recordstore.co.uk/search?q=', domain: 'recordstore.co.uk'},
                    {name: 'EMP', url: 'https://www.emp.co.uk/search?q=', domain: 'emp.co.uk'}
                ];
                
                html += '<div class="mt-3 pt-3 border-t border-gray-100">';
                html += '<p class="text-xs text-gray-400 mb-2 font-medium uppercase tracking-wide">Also check:</p>';
                html += '<div class="grid grid-cols-5 gap-1.5">';
                
                topStores.forEach(store => {
                    const faviconUrl = 'https://www.google.com/s2/favicons?domain=' + store.domain + '&sz=64';
                    html += '<a href="' + store.url + encodeURIComponent(searchTerm) + '" target="_blank" rel="noopener noreferrer" onclick="trackStoreClick(\'' + store.name + '\', \'' + item.album.replace(/'/g, "\\'") + '\')" class="flex flex-col items-center justify-center p-1.5 rounded hover:bg-gray-50 transition-all" title="Search on ' + store.name + '" style="min-height: 52px;">';
                    html += '<img src="' + faviconUrl + '" alt="' + store.name + '" class="w-5 h-5 mb-0.5" onerror="this.style.display=\'none\'">';
                    html += '<span class="text-xs text-gray-600 text-center leading-tight" style="font-size: 9px;">' + store.name + '</span>';
                    html += '</a>';
                });
                
                html += '</div>';
                html += '</div>';
                
                html += '<div id="stores-' + index + '" class="stores-collapsed mt-3 space-y-2">';
                
                const searchTerm = item.artist + ' ' + item.album;
                stores.forEach(store => {
                    html += '<a href="' + store.url + encodeURIComponent(searchTerm) + '" target="_blank" rel="noopener noreferrer" onclick="trackStoreClick(\'' + store.name + '\', \'' + item.album.replace(/'/g, "\\'") + '\')" class="store-button flex items-center gap-2 py-2 px-3 rounded text-sm font-medium text-white hover:opacity-90" style="background-color: #FF6B6B;">';
                    const faviconUrl = 'https://www.google.com/s2/favicons?domain=' + store.domain + '&sz=64';
                    html += '<img src="' + faviconUrl + '" alt="' + store.name + '" class="w-4 h-4 flex-shrink-0" onerror="this.style.display=\'none\'">';
                    html += '<span class="flex-1 text-left">' + store.name + '</span>';
                    html += '<svg class="w-3 h-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                    html += '</a>';
                });
                
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Execute search on page load
        if (searchQuery) {
            searchVinyl(searchQuery).then(displayResults);
        } else {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noResults').style.display = 'block';
            document.getElementById('searchTitle').textContent = 'No search query';
        }
        
        // Store results globally for sorting
        let allResults = [];
        
        // Modified displayResults to store results
        const originalDisplayResults = displayResults;
        displayResults = function(results) {
            allResults = results;
            
            // Show sort controls if we have results
            if (results.length > 0) {
                document.getElementById('sortControls').style.display = 'flex';
                document.getElementById('resultCount').textContent = `${results.length} results`;
            }
            
            originalDisplayResults(results);
        };
        
        // Sort results function
        function sortResults() {
            const sortValue = document.getElementById('sortSelect').value;
            let sorted = [...allResults];
            
            switch(sortValue) {
                case 'relevance':
                    // Original order (POPSTORE and VinylCastle first, then by year)
                    sorted.sort((a, b) => {
                        const aIsRetailer = (a.source === 'popstore' || a.source === 'vinylcastle');
                        const bIsRetailer = (b.source === 'popstore' || b.source === 'vinylcastle');
                        
                        if (aIsRetailer && !bIsRetailer) return -1;
                        if (bIsRetailer && !aIsRetailer) return 1;
                        
                        const yearA = parseInt(a.year) || 0;
                        const yearB = parseInt(b.year) || 0;
                        return yearB - yearA;
                    });
                    break;
                    
                case 'year-desc':
                    // Newest first
                    sorted.sort((a, b) => {
                        const yearA = parseInt(a.year) || 0;
                        const yearB = parseInt(b.year) || 0;
                        return yearB - yearA;
                    });
                    break;
                    
                case 'year-asc':
                    // Oldest first
                    sorted.sort((a, b) => {
                        const yearA = parseInt(a.year) || 0;
                        const yearB = parseInt(b.year) || 0;
                        return yearA - yearB;
                    });
                    break;
                    
                case 'price-asc':
                    // Lowest price first (items with no price go last)
                    sorted.sort((a, b) => {
                        const priceA = a.price || 999999;
                        const priceB = b.price || 999999;
                        return priceA - priceB;
                    });
                    break;
                    
                case 'price-desc':
                    // Highest price first (items with no price go last)
                    sorted.sort((a, b) => {
                        if (!a.price && !b.price) return 0;
                        if (!a.price) return 1;
                        if (!b.price) return -1;
                        return b.price - a.price;
                    });
                    break;
                    
                case 'artist-asc':
                    // A-Z by artist
                    sorted.sort((a, b) => {
                        return a.artist.localeCompare(b.artist);
                    });
                    break;
                    
                case 'artist-desc':
                    // Z-A by artist
                    sorted.sort((a, b) => {
                        return b.artist.localeCompare(a.artist);
                    });
                    break;
                    
                case 'album-asc':
                    // A-Z by album
                    sorted.sort((a, b) => {
                        return a.album.localeCompare(b.album);
                    });
                    break;
                    
                case 'album-desc':
                    // Z-A by album
                    sorted.sort((a, b) => {
                        return b.album.localeCompare(a.album);
                    });
                    break;
            }
            
            // Re-render with sorted results
            originalDisplayResults(sorted);
        }
        
        // Autocomplete functionality for header search
        const headerSearchInput = document.getElementById('headerSearch');
        const headerAutocomplete = document.getElementById('headerAutocomplete');
        let debounceTimer;
        
        headerSearchInput.addEventListener('input', function(e) {
            const value = this.value.trim();
            
            if (value.length < 2) {
                hideHeaderAutocomplete();
                return;
            }
            
            // Debounce API calls
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchHeaderSuggestions(value);
            }, 300);
        });
        
        async function fetchHeaderSuggestions(searchValue) {
            try {
                const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(searchValue)}`);
                
                if (!response.ok) {
                    hideHeaderAutocomplete();
                    return;
                }
                
                const data = await response.json();
                const suggestions = data.suggestions || [];
                
                if (suggestions.length === 0) {
                    hideHeaderAutocomplete();
                    return;
                }
                
                displayHeaderSuggestions(suggestions, searchValue);
                
            } catch (error) {
                console.error('Autocomplete error:', error);
                hideHeaderAutocomplete();
            }
        }
        
        function displayHeaderSuggestions(matches, searchValue) {
            let html = '';
            matches.forEach((match) => {
                const regex = new RegExp('(' + searchValue + ')', 'gi');
                
                if (match.type === 'artist') {
                    // Artist suggestion
                    const artistName = match.name || match;
                    const highlighted = artistName.replace(regex, '<strong>$1</strong>');
                    
                    html += '<div class="autocomplete-item" onclick="selectHeaderSuggestion(\'' + artistName.replace(/'/g, "\\'") + '\')">';
                    html += highlighted;
                    if (match.source === 'popstore') {
                        html += ' <span style="font-size: 10px; color: #FF6B6B;">‚óè</span>';
                    }
                    html += '</div>';
                } else if (match.type === 'album') {
                    // Album suggestion
                    const albumName = match.album;
                    const artistName = match.artist;
                    const highlightedAlbum = albumName.replace(regex, '<strong>$1</strong>');
                    const searchQuery = artistName + ' ' + albumName;
                    
                    html += '<div class="autocomplete-item" onclick="selectHeaderSuggestion(\'' + searchQuery.replace(/'/g, "\\'") + '\')">';
                    html += '<div style="display: flex; align-items: center; gap: 6px;">';
                    html += '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: #FF6B6B;">';
                    html += '<circle cx="12" cy="12" r="10"></circle>';
                    html += '<circle cx="12" cy="12" r="3"></circle>';
                    html += '</svg>';
                    html += '<span>' + highlightedAlbum + ' <span style="color: #999;">¬∑ ' + artistName + '</span></span>';
                    if (match.source === 'popstore') {
                        html += ' <span style="font-size: 10px; color: #FF6B6B;">‚óè</span>';
                    }
                    html += '</div>';
                    html += '</div>';
                } else {
                    // Fallback for old format
                    const artistName = match.name || match;
                    const highlighted = artistName.replace(regex, '<strong>$1</strong>');
                    
                    html += '<div class="autocomplete-item" onclick="selectHeaderSuggestion(\'' + artistName.replace(/'/g, "\\'") + '\')">';
                    html += highlighted;
                    if (match.source === 'popstore') {
                        html += ' <span style="font-size: 10px; color: #FF6B6B;">‚óè</span>';
                    }
                    html += '</div>';
                }
            });
            
            headerAutocomplete.innerHTML = html;
            headerAutocomplete.classList.add('show');
        }
        
        function selectHeaderSuggestion(searchQuery) {
            headerSearchInput.value = searchQuery;
            hideHeaderAutocomplete();
            headerSearchInput.form.submit();
        }
        
        function selectHeaderArtist(artist) {
            selectHeaderSuggestion(artist);
        }
        
        function hideHeaderAutocomplete() {
            headerAutocomplete.classList.remove('show');
        }
        
        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-container')) {
                hideHeaderAutocomplete();
            }
        });
        
        // Handle keyboard navigation
        headerSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideHeaderAutocomplete();
            }
        });
    </script>
</body>
</html>
