<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album - findyl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Raleway:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'DM Serif Display', serif;
            color: #374151;
            font-weight: 400;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'DM Serif Display', serif;
            font-weight: 700;
            color: #111827;
            letter-spacing: -0.01em;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <a href="/" class="flex-shrink-0 hover:opacity-80 transition-opacity">
                    <svg width="128" height="40" viewBox="0 0 320 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <text x="0" y="72" font-family="'DM Serif Display', serif" font-size="80" fill="#1F2937" font-weight="400">findyl</text>
                        <g transform="translate(245, 50)">
                            <circle cx="0" cy="0" r="28" fill="#FF6B6B"/>
                            <circle cx="0" cy="0" r="22" fill="none" stroke="white" stroke-width="1"/>
                            <circle cx="0" cy="0" r="16" fill="none" stroke="white" stroke-width="1"/>
                            <circle cx="0" cy="0" r="10" fill="none" stroke="white" stroke-width="1"/>
                            <circle cx="0" cy="0" r="8" fill="white"/>
                            <circle cx="0" cy="0" r="3" fill="#FF6B6B"/>
                        </g>
                    </svg>
                </a>

                <!-- Search bar -->
                <div class="flex-1 max-w-2xl relative">
                    <form id="header-search-form" class="relative">
                        <input
                            type="text"
                            id="header-search-input" style="font-family:'Raleway', sans-serif;"
                            placeholder="Search for vinyl..."
                            class="w-full px-4 py-2 pr-10 border-[1.5px] border-gray-900 rounded-full focus:border-gray-900 focus:outline-none text-gray-900 placeholder-gray-400"
                            autocomplete="off"
                        />
                        <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2" style="color:#FF6B6B">
                            <svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="9" cy="9" r="6"/><path d="M14 14l4 4"/>
                            </svg>
                        </button>
                    </form>
                    <div id="header-autocomplete" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-2xl shadow-lg z-50 hidden mt-1 overflow-hidden" style="max-height:420px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </header>
    <script src="/findyl-search.js"></script>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm text-gray-600">
            <a href="/" class="hover:text-gray-900">Home</a>
            <span class="mx-2">â€º</span>
            <a href="#" id="breadcrumb-artist" class="hover:text-gray-900">Artist</a>
            <span class="mx-2">â€º</span>
            <span id="breadcrumb-album" class="text-gray-900">Album</span>
        </nav>

        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
            <p class="mt-4 text-gray-600">Loading album...</p>
        </div>

        <div id="content" class="hidden">
            <div class="grid md:grid-cols-[350px_1fr] gap-8">
                <!-- Left: Album Cover & Info -->
                <div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="aspect-square bg-gray-200">
                            <img id="album-cover" src="" alt="" class="w-full h-full object-cover">
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h1 id="album-title" class="text-2xl font-bold mb-2">Album Title</h1>
                        <p id="album-artist" class="text-lg text-gray-600 mb-4">Artist</p>
                        <div id="album-meta" class="text-sm text-gray-500 space-y-1">
                            <!-- Release year, label, etc. -->
                        </div>
                        <div id="discogs-section" class="hidden mt-3 pt-3 border-t border-gray-100 flex items-center justify-between">
                            <span class="text-sm text-gray-500">Discogs Rating</span>
                            <div class="flex items-center gap-2">
                                <span id="discogs-stars" class="text-yellow-400 text-sm"></span>
                                <span id="discogs-rating" class="text-sm font-bold" style="color:#FF6B6B"></span>
                            </div>
                        </div>
                    </div>

                    <div id="tracklist-section" class="bg-white rounded-lg shadow-sm overflow-hidden mt-6">
                        <button id="tracklist-toggle" onclick="toggleTracklist()" class="w-full flex items-center justify-between p-6 hover:bg-gray-50 transition-colors">
                            <h2 class="text-xl font-bold">Tracklist</h2>
                            <span id="tracklist-arrow" class="text-gray-400 text-xl transition-transform duration-200">â–¼</span>
                        </button>
                        <div id="tracklist-body" class="hidden px-6 pb-6">
                            <div id="tracklist" class="space-y-2">
                                <!-- Tracks will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Buy Options -->
                <div>

                    <!-- Buy Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Buy This Album</h2>
                        
                        <div id="buy-options" class="space-y-3">
                            <!-- Checking prices indicator â€” replaced when prices load -->
                            <div id="price-loading" class="text-center py-4 text-gray-400 text-sm">
                                <div class="inline-block animate-spin rounded-full h-5 w-5 border-b-2 border-gray-300 mr-2" style="vertical-align:middle"></div>
                                Checking retailer prices...
                            </div>
                        </div>

                        <!-- Store Quick Links (always visible) -->
                        <div id="store-links" class="mt-3 space-y-2">
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="roughtrade">
                                <img src="https://www.google.com/s2/favicons?domain=roughtrade.com&sz=64" alt="Rough Trade" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Rough Trade</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="banquet">
                                <img src="https://www.google.com/s2/favicons?domain=banquetrecords.com&sz=64" alt="Banquet" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Banquet</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="juno">
                                <img src="https://www.google.com/s2/favicons?domain=juno.co.uk&sz=64" alt="Juno" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Juno</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="recordstore">
                                <img src="https://www.google.com/s2/favicons?domain=recordstore.co.uk&sz=64" alt="Recordstore" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Recordstore</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="fopp">
                                <img src="https://www.google.com/s2/favicons?domain=fopp.com&sz=64" alt="Fopp" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Fopp</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a id="amazon-link" href="#" target="_blank" rel="noopener noreferrer sponsored" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="amazon">
                                <img src="https://www.google.com/s2/favicons?domain=amazon.co.uk&sz=64" alt="Amazon" class="w-8 h-8">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">Amazon</span>
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full whitespace-nowrap" style="background:#FF6B6B;color:#FFFFFF;">New &amp; Used</span>
                                </div>
                                <span class="text-sm text-gray-500">Search listings â†’</span>
                            </a>
                            <a id="ebay-link" href="#" target="_blank" rel="noopener noreferrer sponsored" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="ebay">
                                <img src="https://www.google.com/s2/favicons?domain=ebay.co.uk&sz=64" alt="eBay" class="w-8 h-8">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">eBay</span>
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full whitespace-nowrap" style="background:#FF6B6B;color:#FFFFFF;">New &amp; Used</span>
                                </div>
                                <span class="text-sm text-gray-500">Search listings â†’</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="emp">
                                <img src="https://www.google.com/s2/favicons?domain=emp.co.uk&sz=64" alt="EMP" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">EMP</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <div id="extra-stores"></div>
                        </div>


                    </div>



                </div>
            </div>
        </div>

        <div id="error" class="hidden text-center py-12">
            <p class="text-red-600 text-lg mb-4">Album not found</p>
            <a href="/" class="text-blue-600 hover:underline">Return to search</a>
        </div>
    </main>

    <script>
        // â”€â”€ MusicBrainz rate-limited fetch with retry â”€â”€
        const mbQueue = {
            queue: [],
            processing: false,
            lastRequest: 0,

            fetch(url) {
                return new Promise((resolve, reject) => {
                    this.queue.push({ url, resolve, reject });
                    if (!this.processing) this.process();
                });
            },

            async process() {
                this.processing = true;
                while (this.queue.length > 0) {
                    const { url, resolve, reject } = this.queue.shift();
                    const now = Date.now();
                    const elapsed = now - this.lastRequest;
                    if (elapsed < 1100) {
                        await new Promise(r => setTimeout(r, 1100 - elapsed));
                    }
                    try {
                        const res = await fetchWithRetry(url, {
                            headers: { 'User-Agent': 'findyl/1.0 (https://findyl.co.uk)' }
                        });
                        this.lastRequest = Date.now();
                        resolve(res);
                    } catch (err) {
                        this.lastRequest = Date.now();
                        reject(err);
                    }
                }
                this.processing = false;
            }
        };

        async function fetchWithRetry(url, options = {}, retries = 2) {
            for (let attempt = 0; attempt <= retries; attempt++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return res;
                    if ((res.status === 503 || res.status === 429) && attempt < retries) {
                        await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
                        continue;
                    }
                    return res;
                } catch (err) {
                    if (attempt < retries) {
                        await new Promise(r => setTimeout(r, 1500 * (attempt + 1)));
                        continue;
                    }
                    throw err;
                }
            }
        }

        // â”€â”€ Page init â”€â”€
        const urlParams = new URLSearchParams(window.location.search);
        const albumId = urlParams.get('id');
        const artistName = urlParams.get('artist');

        if (!albumId) {
            window.location.href = '/';
        }

        let albumData = null;

        // Store URLs
        const storeUrls = {
            roughtrade: 'https://www.roughtrade.com/search?q=',
            banquet: 'https://www.banquetrecords.com/search?q=',
            juno: 'https://www.juno.co.uk/search/?q%5Ball%5D%5B%5D=',
            recordstore: 'https://recordstore.co.uk/search?q=',
            fopp: 'https://www.fopp.com/search?term=',
            emp: 'https://www.emp.co.uk/search?q='
        };

        // eBay Partner Network credentials
        const EPN_CAMPAIGN_ID = '5339142783';
        const AMAZON_TAG = 'findyluk-21';
        const EPN_PUBLISHER_ID = '7001477';

        function getEbayUrl(artist, album) {
            const query = encodeURIComponent(artist + ' ' + album + ' vinyl');
            return 'https://www.ebay.co.uk/sch/i.html?_nkw=' + query + '&LH_BIN=1&LH_ItemCondition=1000|1500|2500|3000&mkevt=1&mkcid=1&mkrid=710-53481-19255-0&campid=' + EPN_CAMPAIGN_ID + '&toolid=10001&customid=findyl';
        }

        function getAmazonUrl(artist, album) {
            const query = encodeURIComponent(artist + ' ' + album + ' vinyl');
            return 'https://www.amazon.co.uk/s?k=' + query + '&i=music&tag=' + AMAZON_TAG;
        }

        // More stores
        const moreStores = [
            { name: 'Norman Records', url: 'https://www.normanrecords.com/search?q=' },
            { name: 'Assai Records', url: 'https://www.assai.co.uk/search?q=' },
            { name: 'Resident Music', url: 'https://www.resident-music.com/search?q=' },
            { name: 'Sounds Like Vinyl', url: 'https://www.soundslikevinyl.co.uk/search?q=' },
            { name: 'The Sound of Vinyl', url: 'https://thesoundofvinyl.com/search?q=' },
            { name: 'Merchbar', url: 'https://www.merchbar.com/search?q=' },
            { name: 'Lost in Vinyl', url: 'https://lostinvinyl.co.uk/search?q=' }
        ];

        async function loadAlbumData() {
            try {
                // Get release group details
                const rgResponse = await mbQueue.fetch(
                    `https://musicbrainz.org/ws/2/release-group/${albumId}?inc=releases+tags+genres&fmt=json`
                );

                if (!rgResponse.ok) throw new Error('Album not found');

                albumData = await rgResponse.json();

                // Display album info
                displayAlbumInfo();

                // Set up store links (including extra stores)
                setupStoreLinks();

                // â˜… Show content IMMEDIATELY â€” don't wait for prices/tracklist
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

                // Load prices in background (non-blocking)
                loadPrices().catch(e => console.warn('Price loading failed:', e));

                // Get tracklist from first release (non-blocking)
                if (albumData.releases && albumData.releases.length > 0) {
                    loadTracklist(albumData.releases[0].id).catch(() => {});
                }

                // Load Discogs rating (non-blocking)
                const artistForDiscogs = albumData["artist-credit"] ? albumData["artist-credit"][0].name : artistName;
                loadDiscogsRating(artistForDiscogs, albumData.title, albumId).catch(() => {});

            } catch (error) {
                console.error('Error loading album:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function displayAlbumInfo() {
            const title = albumData.title;
            const artist = albumData['artist-credit'] ? albumData['artist-credit'][0].name : artistName;
            const year = albumData['first-release-date'] ? albumData['first-release-date'].substring(0, 4) : '';

            // Set page title
            document.title = `${title} - ${artist} - findyl`;

            // Breadcrumb
            document.getElementById('breadcrumb-artist').textContent = artist;
            document.getElementById('breadcrumb-artist').href = `/artist?name=${encodeURIComponent(artist)}`;
            document.getElementById('breadcrumb-album').textContent = title;

            // Album info
            document.getElementById('album-title').textContent = title;
            document.getElementById('album-artist').textContent = artist;
            document.getElementById('album-cover').src = `https://coverartarchive.org/release-group/${albumId}/front-500`;
            document.getElementById('album-cover').alt = title;
            document.getElementById('album-cover').onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22500%22 height=%22500%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22500%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2224%22 fill=%22%239ca3af%22%3ENo Cover%3C/text%3E%3C/svg%3E';
            };

            // Meta info
            const meta = [];
            if (year) meta.push(`Released: ${year}`);
            if (albumData['primary-type']) meta.push(`Format: ${albumData['primary-type']}`);

            document.getElementById('album-meta').innerHTML = meta.map(m => `<p>${m}</p>`).join('');
        }

        function setupStoreLinks() {
            const searchQuery = `${artistName} ${albumData.title}`;
            
            // Setup quick links
            document.querySelectorAll('.store-link').forEach(link => {
                const store = link.dataset.store;
                if (storeUrls[store]) {
                    link.href = storeUrls[store] + encodeURIComponent(searchQuery);
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                }
            });

            // Set Amazon affiliate link
            const artist = albumData['artist-credit'] ? albumData['artist-credit'][0].name : artistName;
            const amazonLink = document.getElementById('amazon-link');
            if (amazonLink) {
                amazonLink.href = getAmazonUrl(artistName || artist, albumData.title);
            }

            // Set eBay affiliate link
            const ebayLink = document.getElementById('ebay-link');
            if (ebayLink) {
                ebayLink.href = getEbayUrl(artistName || artist, albumData.title);
            }

            // â˜… Render extra stores (was missing before!)
            const extraDiv = document.getElementById('extra-stores');
            if (extraDiv) {
                extraDiv.innerHTML = moreStores.map(store => {
                    const domain = new URL(store.url).hostname;
                    return `
                        <a href="${store.url}${encodeURIComponent(searchQuery)}" 
                           target="_blank" rel="noopener noreferrer"
                           class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=64" alt="${store.name}" class="w-8 h-8">
                            <span class="font-semibold text-gray-900 flex-1">${store.name}</span>
                            <span class="text-sm text-gray-500">Check store for price</span>
                        </a>
                    `;
                }).join('');
            }
        }

        async function loadPrices() {
            const artist = albumData?.['artist-credit']?.[0]?.name || artistName;
            const albumTitle = albumData?.title || '';

            try {
                console.log('ðŸ” Searching for artist:', artistName);
                
                // Fetch hybrid search AND eBay in parallel
                const [hybridRes, ebayRes] = await Promise.allSettled([
                    fetch(`/api/hybrid-search?q=${encodeURIComponent(artistName)}`),
                    fetch(`/api/ebay-search?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(albumTitle)}`)
                ]);

                // Remove loading indicator
                const loadingEl = document.getElementById('price-loading');
                if (loadingEl) loadingEl.remove();

                const allBuyOptions = [];

                // â”€â”€ Process hybrid search results (POPSTORE, VinylCastle, EMP) â”€â”€
                if (hybridRes.status === 'fulfilled' && hybridRes.value.ok) {
                    const results = await hybridRes.value.json();
                    console.log('ðŸ“¦ Hybrid search returned:', results.length, 'results for', artistName);

                    const matchingAlbums = results.filter(r => {
                        const artistMatch = r.artist.toLowerCase() === artistName.toLowerCase();
                        if (!artistMatch) return false;
                        
                        const albumLower = r.album.toLowerCase();
                        const titleLower = albumData.title.toLowerCase();
                        
                        const cleanAlbum = albumLower.replace(/\b(the|a|an)\b/g, '').trim();
                        const cleanTitle = titleLower.replace(/\b(the|a|an)\b/g, '').trim();
                        
                        return cleanAlbum.includes(cleanTitle) || cleanTitle.includes(cleanAlbum);
                    });
                    
                    console.log('ðŸŽ¯ Found', matchingAlbums.length, 'matching albums');
                    
                    matchingAlbums.forEach(album => {
                        if (album.buyOptions) {
                            album.buyOptions.forEach(opt => {
                                const textToCheck = opt.rawProductName || album.album || '';
                                opt.vinylColour = detectVinylColour(textToCheck);
                            });
                            allBuyOptions.push(...album.buyOptions);
                        }
                    });
                }

                // â”€â”€ Process eBay results â”€â”€
                if (ebayRes.status === 'fulfilled' && ebayRes.value.ok) {
                    const ebayData = await ebayRes.value.json();
                    console.log('ðŸ›’ eBay returned:', ebayData.count, 'results');

                    if (ebayData.results && ebayData.results.length > 0) {
                        // Hide the static eBay link since we have live pricing
                        const staticEbayLink = document.getElementById('ebay-link');
                        if (staticEbayLink) staticEbayLink.style.display = 'none';

                        // Take up to 10 best eBay results
                        const ebayOptions = ebayData.results.slice(0, 10).map(item => {
                            // Server returns vinylColour as string, convert to {label,hex} or use client detection
                            let vc = null;
                            if (item.vinylColour) {
                                // Server detected a colour â€” run client detection on title to get hex
                                vc = detectVinylColour(item.title || '') || { label: item.vinylColour, hex: '#FF6B6B' };
                            }
                            return {
                                storeName: 'eBay',
                                source: 'ebay',
                                price: item.price,
                                link: item.link,
                                availability: 'In Stock',
                                condition: item.condition || '',
                                seller: item.seller || '',
                                vinylColour: vc
                            };
                        });
                        allBuyOptions.push(...ebayOptions);
                    }
                }

                if (allBuyOptions.length > 0) {
                    console.log('âœ… Total buy options:', allBuyOptions.length);
                    displayBuyOptions(allBuyOptions);
                }

            } catch (error) {
                console.error('Error loading prices:', error);
                const loadingEl = document.getElementById('price-loading');
                if (loadingEl) loadingEl.remove();
            }
        }

        // Vinyl colour detection (works on any product title)
        // Returns { label, hex } or null â€” hex uses pastel palette
        function detectVinylColour(text) {
            text = (text || '').toLowerCase();

            const isJustBlack = /\bblack\s+vinyl\b/.test(text)
                && !/splatter|marble|swirl|split|mix|stripe|smoke/i.test(text);
            if (isJustBlack) return null;

            const colourPatterns = [
                { pattern: /\b(splatter(?:ed)?)\s*(vinyl|lp|disc)?\b/, label: 'Splatter', hex: '#9A88D8' },
                { pattern: /\b(marble(?:d)?)\s*(vinyl|lp|disc)?\b/, label: 'Marble', hex: '#7B8ED8' },
                { pattern: /\b(swirl(?:ed)?)\s*(vinyl|lp|disc)?\b/, label: 'Swirl', hex: '#B68AD8' },
                { pattern: /\b(tie[- ]?dye(?:d)?)\s*(vinyl|lp|disc)?\b/, label: 'Tie-Dye', hex: '#E080B0' },
                { pattern: /\b(galaxy)\s*(vinyl|lp|disc)?\b/, label: 'Galaxy', hex: '#6670D0' },
                { pattern: /\b(haze)\s*(vinyl|lp|disc)?\b/, label: 'Haze', hex: '#9AABB8' },
                { pattern: /\b(smoke(?:d|y)?)\s*(vinyl|lp|disc)?\b/, label: 'Smoke', hex: '#7A8A9C' },
                { pattern: /\b(translucent|transparent)\s*(vinyl|lp|disc)?\b/, label: 'Translucent', hex: '#7CBCD8' },
                { pattern: /\b(picture\s*disc)\b/, label: 'Picture Disc', hex: '#D4B85C' },
                { pattern: /\b(glow.in.the.dark)\b/, label: 'Glow in the Dark', hex: '#8CC044' },
                { pattern: /\b(red)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Red', hex: '#E87C7C' },
                { pattern: /\b(blue)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Blue', hex: '#6BA3E0' },
                { pattern: /\b(green)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Green', hex: '#5BBF8A' },
                { pattern: /\b(yellow)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Yellow', hex: '#D4B85C' },
                { pattern: /\b(orange)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Orange', hex: '#E09558' },
                { pattern: /\b(pink)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Pink', hex: '#E080B0' },
                { pattern: /\b(purple)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Purple', hex: '#B68AD8' },
                { pattern: /\b(white)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'White', hex: '#A8B4C0' },
                { pattern: /\b(clear)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Clear', hex: '#7CBCD8' },
                { pattern: /\b(gold)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Gold', hex: '#D4B85C' },
                { pattern: /\b(silver)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Silver', hex: '#9AABB8' },
                { pattern: /\b(grey|gray)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Grey', hex: '#9AABB8' },
                { pattern: /\b(cream)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Cream', hex: '#D4C08A' },
                { pattern: /\b(turquoise|teal)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Turquoise', hex: '#5CC8B0' },
                { pattern: /\b(magenta)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Magenta', hex: '#C87CD8' },
                { pattern: /\b(burgundy|maroon)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Burgundy', hex: '#D88A8A' },
                { pattern: /\b(cobalt)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Cobalt', hex: '#7B8ED8' },
                { pattern: /\b(coral)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Coral', hex: '#E08A8A' },
                { pattern: /\b(mint)\s+(vinyl|lp|pressing|colou?red)\b/, label: 'Mint', hex: '#6CC8A0' },
                { pattern: /\b(colou?red)\s+(vinyl|lp|pressing)\b/, label: 'Coloured', hex: '#E08A8A' },
                { pattern: /\b(limited)\s+(colou?r|edition)\b.*\bvinyl\b/, label: 'Limited Colour', hex: '#E08A8A' },
                { pattern: /lp\s*\[([^\]]*red[^\]]*)\]/i, label: null, extract: true, hex: '#E87C7C' },
                { pattern: /lp\s*\[([^\]]*blue[^\]]*)\]/i, label: null, extract: true, hex: '#6BA3E0' },
                { pattern: /lp\s*\[([^\]]*green[^\]]*)\]/i, label: null, extract: true, hex: '#5BBF8A' },
                { pattern: /lp\s*\[([^\]]*orange[^\]]*)\]/i, label: null, extract: true, hex: '#E09558' },
                { pattern: /lp\s*\[([^\]]*pink[^\]]*)\]/i, label: null, extract: true, hex: '#E080B0' },
                { pattern: /lp\s*\[([^\]]*purple[^\]]*)\]/i, label: null, extract: true, hex: '#B68AD8' },
                { pattern: /lp\s*\[([^\]]*white[^\]]*)\]/i, label: null, extract: true, hex: '#A8B4C0' },
                { pattern: /lp\s*\[([^\]]*clear[^\]]*)\]/i, label: null, extract: true, hex: '#7CBCD8' },
                { pattern: /lp\s*\[([^\]]*gold[^\]]*)\]/i, label: null, extract: true, hex: '#D4B85C' },
                { pattern: /lp\s*\[([^\]]*splatter[^\]]*)\]/i, label: null, extract: true, hex: '#9A88D8' },
                { pattern: /lp\s*\[([^\]]*marble[^\]]*)\]/i, label: null, extract: true, hex: '#7B8ED8' },
                { pattern: /lp\s*\[([^\]]*swirl[^\]]*)\]/i, label: null, extract: true, hex: '#B68AD8' },
                { pattern: /lp\s*\[([^\]]+)\]/i, label: null, extract: true, hex: '#E08A8A' },
            ];

            for (const { pattern, label, extract, hex } of colourPatterns) {
                const match = text.match(pattern);
                if (match) {
                    if (extract && match[1]) {
                        const col = match[1].trim();
                        return { label: col.charAt(0).toUpperCase() + col.slice(1), hex };
                    }
                    return { label, hex };
                }
            }
            return null;
        }

        // Known eBay retailer sellers â†’ display name + favicon domain
        const knownEbaySellers = {
            'hmv_official_store':   { name: 'HMV',              domain: 'hmv.com' },
            'hmvstore':             { name: 'HMV',              domain: 'hmv.com' },
            'rarewaves-outlet':     { name: 'Rarewaves',        domain: 'rarewaves.com' },
            'rarewaves':            { name: 'Rarewaves',        domain: 'rarewaves.com' },
            'rarewaves_superstore': { name: 'Rarewaves',        domain: 'rarewaves.com' },
            'junorecords':          { name: 'Juno Records',     domain: 'juno.co.uk' },
            'musicmagpie_shop':     { name: 'musicMagpie',      domain: 'musicmagpie.co.uk' },
            'musicmagpie':          { name: 'musicMagpie',      domain: 'musicmagpie.co.uk' },
            'zaborrecords':         { name: 'Zaborrecords',     domain: 'zabor.co.uk' },
            'rough_trade':          { name: 'Rough Trade',      domain: 'roughtrade.com' },
            'roughtrade':           { name: 'Rough Trade',      domain: 'roughtrade.com' },
            'banaborecords':        { name: 'Banquet Records',  domain: 'banquetrecords.com' },
            'empukstore':           { name: 'EMP',              domain: 'emp.co.uk' },
            'zavvi_outlet':         { name: 'Zavvi',            domain: 'zavvi.com' },
            'zavvistore':           { name: 'Zavvi',            domain: 'zavvi.com' },
            'thesoundofvinyluk':    { name: 'Sound of Vinyl',   domain: 'thesoundofvinyl.com' },
            'assairecords':         { name: 'Assai Records',    domain: 'assai.co.uk' },
            'resident-music':       { name: 'Resident Music',   domain: 'resident-music.com' },
            'normanrecords':        { name: 'Norman Records',   domain: 'normanrecords.com' },
            'blackwellsonline':     { name: 'Blackwell\'s',     domain: 'blackwells.co.uk' },
            'worldofbooksltd':      { name: 'World of Books',   domain: 'worldofbooks.com' },
            'chalkys_uk':           { name: 'Chalkys',          domain: 'chalkys.com' },
        };

        function getSellerInfo(seller) {
            if (!seller) return { displayName: 'eBay seller', logo: null };
            const key = seller.toLowerCase().replace(/[-_.\s]/g, '_');
            const match = knownEbaySellers[key] || knownEbaySellers[seller.toLowerCase()];
            if (match) {
                return {
                    displayName: match.name,
                    logo: `<img src="https://www.google.com/s2/favicons?domain=${match.domain}&sz=64" alt="${match.name}" style="width:20px;height:20px;border-radius:3px;flex-shrink:0;">`
                };
            }
            return { displayName: seller, logo: null };
        }

        function displayBuyOptions(options) {
            const container = document.getElementById('buy-options');

            // Separate eBay from other retailers
            const retailerOptions = options.filter(o => o.source !== 'ebay');
            const ebayOptions = options.filter(o => o.source === 'ebay');

            // Sort retailers by price
            retailerOptions.sort((a, b) => a.price - b.price);

            // Store logo: returns HTML for the logo image/SVG
            function getStoreLogo(source, storeName) {
                if (source === 'ebay') {
                    return `<svg width="32" height="32" viewBox="0 0 120 48" style="flex-shrink:0;">
                        <text x="0" y="38" font-family="Helvetica,Arial,sans-serif" font-weight="700" font-size="40">
                            <tspan fill="#E53238">e</tspan><tspan fill="#0064D2">b</tspan><tspan fill="#F5AF02">a</tspan><tspan fill="#86B817">y</tspan>
                        </text>
                    </svg>`;
                }
                const domains = {
                    popstore: 'wearepopstore.com',
                    vinylcastle: 'vinylcastle.co.uk',
                    emp: 'emp.co.uk'
                };
                const domain = domains[source] || 'example.com';
                return `<img src="https://www.google.com/s2/favicons?domain=${domain}&sz=64" alt="${storeName}" style="width:32px;height:32px;flex-shrink:0;">`;
            }

            // â”€â”€ Render standard retailer cards â”€â”€
            let html = retailerOptions.map(opt => {
                const vcHex = (opt.vinylColour && typeof opt.vinylColour === 'object') ? opt.vinylColour.hex : '#FF6B6B';
                const cb = opt.vinylColour ? `<span style="font-size:0.6rem;padding:2px 7px;border-radius:9999px;background:${vcHex};color:#FFFFFF;white-space:nowrap;font-weight:500;">Colour variant</span>` : '';
                return `
                <a href="${opt.link}" 
                   target="_blank" rel="noopener noreferrer"
                   class="block py-3 px-4 sm:py-4 sm:px-6 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100">
                    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;">
                        <div style="display:flex;align-items:center;gap:8px;min-width:0;">
                            ${getStoreLogo(opt.source, opt.storeName)}
                            <span style="font-weight:600;color:#1F2937;font-size:0.95rem;">${opt.storeName}</span>
                            ${cb}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
                            <span style="font-weight:700;color:#FF6B6B;font-size:1.25rem;">Â£${opt.price.toFixed(2)}</span>
                            ${opt.availability === 'In Stock' ? '<span style="color:#10b981;font-size:0.8rem;font-weight:500;white-space:nowrap;">âœ“</span>' : ''}
                        </div>
                    </div>
                </a>`;
            }).join('');

            // â”€â”€ Render eBay grouped cards (New + Used) â”€â”€
            if (ebayOptions.length > 0) {
                // Split into New and Used (Pre-Owned)
                const ebayNew = ebayOptions.filter(o => {
                    const c = (o.condition || '').toLowerCase();
                    return c.includes('new') && !c.includes('pre-owned') && !c.includes('used');
                }).sort((a, b) => a.price - b.price);

                const ebayUsed = ebayOptions.filter(o => {
                    const c = (o.condition || '').toLowerCase();
                    return c.includes('pre-owned') || c.includes('used') || c.includes('good') || c.includes('acceptable');
                }).sort((a, b) => a.price - b.price);

                // Anything that doesn't clearly match â€” treat as New
                const ebayOther = ebayOptions.filter(o => {
                    const c = (o.condition || '').toLowerCase();
                    const isNew = c.includes('new') && !c.includes('pre-owned') && !c.includes('used');
                    const isUsed = c.includes('pre-owned') || c.includes('used') || c.includes('good') || c.includes('acceptable');
                    return !isNew && !isUsed;
                }).sort((a, b) => a.price - b.price);

                // Merge uncategorised into New
                const allNew = [...ebayNew, ...ebayOther].sort((a, b) => a.price - b.price);

                if (allNew.length > 0) {
                    html += renderEbayGroup(allNew, 'New', getStoreLogo);
                }
                if (ebayUsed.length > 0) {
                    html += renderEbayGroup(ebayUsed, 'Used', getStoreLogo);
                }
            }

            container.innerHTML = html;

            // Wire up eBay dropdown toggles
            container.querySelectorAll('[data-ebay-toggle]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const targetId = btn.getAttribute('data-ebay-toggle');
                    const dropdown = document.getElementById(targetId);
                    const arrow = btn.querySelector('.ebay-arrow');
                    if (dropdown.classList.contains('hidden')) {
                        dropdown.classList.remove('hidden');
                        arrow.style.transform = 'rotate(180deg)';
                    } else {
                        dropdown.classList.add('hidden');
                        arrow.style.transform = 'rotate(0deg)';
                    }
                });
            });
        }

        function renderEbayGroup(items, label, getStoreLogo) {
            const cheapest = items[0];
            const others = items.slice(1);
            const groupId = `ebay-${label.toLowerCase()}-dropdown`;
            const conditionLabel = label === 'New' ? 'New' : 'Pre-Owned';
            const cheapestSeller = getSellerInfo(cheapest.seller);

            function colourBadge(vc) {
                if (!vc) return '';
                const hex = (typeof vc === 'object' && vc.hex) ? vc.hex : '#FF6B6B';
                return `<span style="font-size:0.6rem;padding:2px 7px;border-radius:9999px;background:${hex};color:#FFFFFF;white-space:nowrap;font-weight:500;">Colour variant</span>`;
            }

            let card = `
            <div class="rounded-lg bg-white shadow-sm border border-gray-100 overflow-hidden">
                <a href="${cheapest.link}" target="_blank" rel="noopener noreferrer sponsored"
                   style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 16px;text-decoration:none;flex-wrap:wrap;">
                    <div style="display:flex;align-items:center;gap:8px;min-width:0;">
                        ${getStoreLogo('ebay', 'eBay')}
                        <span style="font-weight:600;color:#1F2937;font-size:0.95rem;">eBay</span>
                        <span style="font-size:0.6rem;padding:2px 7px;border-radius:9999px;background:${label === 'New' ? '#ECFDF5' : '#D4C08A'};color:${label === 'New' ? '#059669' : '#92400E'};white-space:nowrap;">${conditionLabel}</span>
                        ${colourBadge(cheapest.vinylColour)}
                        ${cheapestSeller.logo ? `<span style="display:flex;align-items:center;">${cheapestSeller.logo}</span>` : ''}
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
                        <span style="font-weight:700;color:#FF6B6B;font-size:1.25rem;">Â£${cheapest.price.toFixed(2)}</span>
                        <span style="color:#10b981;font-size:0.8rem;font-weight:500;white-space:nowrap;">âœ“</span>
                    </div>
                </a>`;

            if (others.length > 0) {
                card += `
                <button data-ebay-toggle="${groupId}" 
                        style="width:100%;padding:6px 16px 8px;display:flex;align-items:center;gap:6px;background:none;border:none;border-top:1px solid #F3F4F6;cursor:pointer;color:#9CA3AF;font-size:0.75rem;font-family:'Raleway',sans-serif;">
                    <svg class="ebay-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="transition:transform 0.2s;"><path d="M6 9l6 6 6-6"/></svg>
                    <span>${others.length} more from Â£${others[0].price.toFixed(2)}</span>
                </button>
                <div id="${groupId}" class="hidden">
                    ${others.map(opt => {
                        const si = getSellerInfo(opt.seller);
                        return `
                        <a href="${opt.link}" target="_blank" rel="noopener noreferrer sponsored"
                           style="display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 16px 8px 36px;text-decoration:none;transition:background 0.15s;border-top:1px solid #F7F7F7;"
                           onmouseenter="this.style.background='#F9FAFB'" onmouseleave="this.style.background='transparent'">
                            <div style="display:flex;align-items:center;gap:6px;min-width:0;flex-wrap:wrap;">
                                ${si.logo || '<span style="width:20px;"></span>'}
                                <span style="font-size:0.8rem;color:#374151;font-weight:500;">${si.displayName}</span>
                                ${colourBadge(opt.vinylColour)}
                            </div>
                            <span style="font-weight:600;color:#FF6B6B;font-size:0.95rem;flex-shrink:0;">Â£${opt.price.toFixed(2)}</span>
                        </a>`;
                    }).join('')}
                </div>`;
            }

            card += `</div>`;
            return card;
        }

        async function loadDiscogsRating(artist, album, mbid) {
            try {
                const res = await fetch(`/api/discogs-rating?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&mbid=${encodeURIComponent(mbid || "")}`);
                if (!res.ok) return;
                const data = await res.json();

                const fullStars = Math.floor(data.rating);
                const halfStar = (data.rating % 1) >= 0.5 ? 'Â½' : '';
                const stars = 'â˜…'.repeat(fullStars) + halfStar;

                document.getElementById('discogs-rating').textContent = data.rating.toFixed(1) + ' / 5';
                document.getElementById('discogs-stars').textContent = stars;
                document.getElementById('discogs-section').classList.remove('hidden');

            } catch(e) {
                console.error('Discogs rating error:', e);
            }
        }

        async function loadTracklist(releaseId) {
            try {
                const response = await mbQueue.fetch(
                    `https://musicbrainz.org/ws/2/release/${releaseId}?inc=recordings&fmt=json`
                );

                if (!response.ok) return;

                const release = await response.json();
                const tracks = [];

                if (release.media) {
                    release.media.forEach(medium => {
                        if (medium.tracks) {
                            medium.tracks.forEach(track => {
                                tracks.push({
                                    position: track.position,
                                    title: track.title,
                                    length: track.length
                                });
                            });
                        }
                    });
                }

                if (tracks.length > 0) {
                    displayTracklist(tracks);
                } else {
                    document.getElementById('tracklist-section').classList.add('hidden');
                }

            } catch (error) {
                console.error('Error loading tracklist:', error);
                document.getElementById('tracklist-section').classList.add('hidden');
            }
        }

        function displayTracklist(tracks) {
            const container = document.getElementById('tracklist');
            
            container.innerHTML = tracks.map(track => {
                const duration = track.length ? formatDuration(track.length) : '';
                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div class="flex gap-3">
                            <span class="text-gray-400 font-mono text-sm w-6">${track.position}</span>
                            <span class="text-gray-900">${track.title}</span>
                        </div>
                        ${duration ? `<span class="text-gray-500 text-sm font-mono">${duration}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function toggleTracklist() {
            const body = document.getElementById('tracklist-body');
            const arrow = document.getElementById('tracklist-arrow');
            const isHidden = body.classList.contains('hidden');
            body.classList.toggle('hidden');
            arrow.style.transform = isHidden ? 'rotate(180deg)' : '';
        }

        // Initialize
        loadAlbumData();
    </script>
</body>
</html>
