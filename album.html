<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Album - findyl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'DM Serif Display', serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-2">
                    <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="48" fill="#FF6B6B" stroke="white" stroke-width="2"/>
                        <circle cx="50" cy="50" r="35" fill="none" stroke="white" stroke-width="2"/>
                        <circle cx="50" cy="50" r="22" fill="none" stroke="white" stroke-width="2"/>
                        <circle cx="50" cy="50" r="6" fill="white"/>
                    </svg>
                    <span class="text-2xl font-bold">findyl</span>
                </a>
                <nav class="flex gap-6">
                    <a href="/stores" class="text-gray-600 hover:text-gray-900">Stores</a>
                    <a href="/about" class="text-gray-600 hover:text-gray-900">About</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-6 text-sm text-gray-600">
            <a href="/" class="hover:text-gray-900">Home</a>
            <span class="mx-2">â€º</span>
            <a href="#" id="breadcrumb-artist" class="hover:text-gray-900">Artist</a>
            <span class="mx-2">â€º</span>
            <span id="breadcrumb-album" class="text-gray-900">Album</span>
        </nav>

        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
            <p class="mt-4 text-gray-600">Loading album...</p>
        </div>

        <div id="content" class="hidden">
            <div class="grid md:grid-cols-[350px_1fr] gap-8">
                <!-- Left: Album Cover & Info -->
                <div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
                        <div class="aspect-square bg-gray-200">
                            <img id="album-cover" src="" alt="" class="w-full h-full object-cover">
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h1 id="album-title" class="text-2xl font-bold mb-2">Album Title</h1>
                        <p id="album-artist" class="text-lg text-gray-600 mb-4">Artist</p>
                        <div id="album-meta" class="text-sm text-gray-500 space-y-1">
                            <!-- Release year, label, etc. -->
                        </div>
                    </div>
                </div>

                <!-- Right: Buy Options & Tracklist -->
                <div>
                    <!-- Discogs Rating -->
                    <div id="discogs-section" class="hidden bg-white rounded-lg shadow-sm p-6 mb-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                            <div>
                                <h2 class="text-xl font-bold mb-1">Community Rating</h2>
                                <p class="text-sm text-gray-500">Based on Discogs collector ratings</p>
                            </div>
                            <div class="sm:text-right">
                                <div id="discogs-rating" class="text-4xl font-bold" style="color:#FF6B6B"></div>
                                <div id="discogs-stars" class="text-yellow-400 text-lg mt-0.5"></div>
                                <div id="discogs-count" class="text-sm text-gray-500 mt-0.5"></div>
                            </div>
                        </div>
                        <div class="flex gap-6 mt-4 pt-4 border-t border-gray-100 text-sm text-gray-600">
                            <div><span id="discogs-have" class="font-semibold text-gray-900"></span> own this</div>
                            <div><span id="discogs-want" class="font-semibold text-gray-900"></span> want this</div>
                        </div>
                    </div>

                    <!-- Buy Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Buy This Album</h2>
                        
                        <div id="buy-options" class="space-y-3">
                            <!-- Buy buttons will be inserted here -->
                        </div>

                        <!-- Store Quick Links (always visible) -->
                        <div id="store-links" class="mt-3 space-y-2">
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="roughtrade">
                                <img src="https://www.google.com/s2/favicons?domain=roughtrade.com&sz=64" alt="Rough Trade" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Rough Trade</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="banquet">
                                <img src="https://www.google.com/s2/favicons?domain=banquetrecords.com&sz=64" alt="Banquet" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Banquet</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="juno">
                                <img src="https://www.google.com/s2/favicons?domain=juno.co.uk&sz=64" alt="Juno" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Juno</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="recordstore">
                                <img src="https://www.google.com/s2/favicons?domain=recordstore.co.uk&sz=64" alt="Recordstore" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Recordstore</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="fopp">
                                <img src="https://www.google.com/s2/favicons?domain=fopp.com&sz=64" alt="Fopp" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">Fopp</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                            <a id="ebay-link" href="#" target="_blank" rel="noopener noreferrer sponsored" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="ebay">
                                <img src="https://www.google.com/s2/favicons?domain=ebay.co.uk&sz=64" alt="eBay" class="w-8 h-8">
                                <div class="flex-1">
                                    <span class="font-semibold text-gray-900">eBay</span>
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full" style="background:#FFE5E5;color:#FF6B6B;">New &amp; Used</span>
                                </div>
                                <span class="text-sm text-gray-500">Search listings â†’</span>
                            </a>
                            <a href="#" class="store-link flex items-center gap-3 p-4 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100" data-store="emp">
                                <img src="https://www.google.com/s2/favicons?domain=emp.co.uk&sz=64" alt="EMP" class="w-8 h-8">
                                <span class="font-semibold text-gray-900 flex-1">EMP</span>
                                <span class="text-sm text-gray-500">Check store for price</span>
                            </a>
                        </div>

                        <button id="more-stores-btn" class="w-full mt-4 py-2 px-4 text-gray-600 hover:text-gray-900 text-sm font-medium">
                            More stores â–¼
                        </button>

                        <div id="more-stores" class="hidden mt-3 space-y-2">
                            <!-- More stores dropdown -->
                        </div>
                    </div>



                    <div id="tracklist-section" class="bg-white rounded-lg shadow-sm p-6">
                        <h2 class="text-xl font-bold mb-4">Tracklist</h2>
                        <div id="tracklist" class="space-y-2">
                            <!-- Tracks will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="hidden text-center py-12">
            <p class="text-red-600 text-lg mb-4">Album not found</p>
            <a href="/" class="text-blue-600 hover:underline">Return to search</a>
        </div>
    </main>

    <script>
        // Get album ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const albumId = urlParams.get('id');
        const artistName = urlParams.get('artist');

        if (!albumId) {
            window.location.href = '/';
        }

        let albumData = null;

        // Store URLs
        const storeUrls = {
            roughtrade: 'https://www.roughtrade.com/search?q=',
            banquet: 'https://www.banquetrecords.com/search?q=',
            juno: 'https://www.juno.co.uk/search/?q%5Ball%5D%5B%5D=',
            recordstore: 'https://recordstore.co.uk/search?q=',
            fopp: 'https://www.fopp.com/search?term=',
            emp: 'https://www.emp.co.uk/search?q='
        };


        // eBay Partner Network credentials
        const EPN_CAMPAIGN_ID = '5339142783';
        const EPN_PUBLISHER_ID = '7001477';

        function getEbayUrl(artist, album) {
            const query = encodeURIComponent(artist + ' ' + album + ' vinyl');
            return 'https://www.ebay.co.uk/sch/i.html?_nkw=' + query + '&LH_BIN=1&LH_ItemCondition=1000|1500|2500|3000&mkevt=1&mkcid=1&mkrid=710-53481-19255-0&campid=' + EPN_CAMPAIGN_ID + '&toolid=10001&customid=findyl';
        }

        // More stores
        const moreStores = [
            { name: 'Norman Records', url: 'https://www.normanrecords.com/search?q=' },
            { name: 'Assai Records', url: 'https://www.assai.co.uk/search?q=' },
            { name: 'Resident Music', url: 'https://www.resident-music.com/search?q=' },
            { name: 'Sounds Like Vinyl', url: 'https://www.soundslikevinyl.co.uk/search?q=' },
            { name: 'The Sound of Vinyl', url: 'https://thesoundofvinyl.com/search?q=' },
            { name: 'Merchbar', url: 'https://www.merchbar.com/search?q=' },
            { name: 'Lost in Vinyl', url: 'https://lostinvinyl.co.uk/search?q=' }
        ];

        async function loadAlbumData() {
            try {
                // Get release group details
                const rgResponse = await fetch(
                    `https://musicbrainz.org/ws/2/release-group/${albumId}?inc=releases+tags+genres&fmt=json`,
                    { headers: { 'User-Agent': 'findyl/1.0 (https://findyl.co.uk)' } }
                );

                if (!rgResponse.ok) throw new Error('Album not found');

                albumData = await rgResponse.json();

                // Display album info
                displayAlbumInfo();

                // Set up store links
                setupStoreLinks();

                // Get prices from retailers
                await loadPrices();

                // Get tracklist from first release
                if (albumData.releases && albumData.releases.length > 0) {
                    await loadTracklist(albumData.releases[0].id);
                }

                // Load Discogs rating (non-blocking)
                const artistForDiscogs = albumData["artist-credit"] ? albumData["artist-credit"][0].name : artistName;
                loadDiscogsRating(artistForDiscogs, albumData.title, albumId).catch(() => {});

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

            } catch (error) {
                console.error('Error loading album:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function displayAlbumInfo() {
            const title = albumData.title;
            const artist = albumData['artist-credit'] ? albumData['artist-credit'][0].name : artistName;
            const year = albumData['first-release-date'] ? albumData['first-release-date'].substring(0, 4) : '';

            // Set page title
            document.title = `${title} - ${artist} - findyl`;

            // Breadcrumb
            document.getElementById('breadcrumb-artist').textContent = artist;
            document.getElementById('breadcrumb-artist').href = `/artist?name=${encodeURIComponent(artist)}`;
            document.getElementById('breadcrumb-album').textContent = title;

            // Album info
            document.getElementById('album-title').textContent = title;
            document.getElementById('album-artist').textContent = artist;
            document.getElementById('album-cover').src = `https://coverartarchive.org/release-group/${albumId}/front-500`;
            document.getElementById('album-cover').alt = title;
            document.getElementById('album-cover').onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22500%22 height=%22500%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22500%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2224%22 fill=%22%239ca3af%22%3ENo Cover%3C/text%3E%3C/svg%3E';
            };

            // Meta info
            const meta = [];
            if (year) meta.push(`Released: ${year}`);
            if (albumData['primary-type']) meta.push(`Format: ${albumData['primary-type']}`);

            document.getElementById('album-meta').innerHTML = meta.map(m => `<p>${m}</p>`).join('');
        }

        function setupStoreLinks() {
            const searchQuery = `${artistName} ${albumData.title}`;
            
            // Setup quick links
            document.querySelectorAll('.store-link').forEach(link => {
                const store = link.dataset.store;
                if (storeUrls[store]) {
                    link.href = storeUrls[store] + encodeURIComponent(searchQuery);
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                }
            });

            // Setup more stores dropdown
            const moreStoresDiv = document.getElementById('more-stores');
            moreStoresDiv.innerHTML = moreStores.map(store => `
                <a href="${store.url}${encodeURIComponent(searchQuery)}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="block py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                   style="background-color: white; border: 2px solid #FF6B6B; color: #1F2937;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="https://www.google.com/s2/favicons?domain=${store.url.split('/')[2]}&sz=64" 
                             alt="${store.name}" 
                             style="width: 20px; height: 20px;">
                        <span style="font-weight: 500;">${store.name}</span>
                    </div>
                </a>
            `).join('');


            // Set eBay affiliate link
            const ebayLink = document.getElementById('ebay-link');
            if (ebayLink) {
                ebayLink.href = getEbayUrl(artistName || artist, albumData.title);
            }
            // Toggle more stores
            document.getElementById('more-stores-btn').addEventListener('click', () => {
                const dropdown = document.getElementById('more-stores');
                dropdown.classList.toggle('hidden');
                const btn = document.getElementById('more-stores-btn');
                btn.textContent = dropdown.classList.contains('hidden') ? 'More stores â–¼' : 'More stores â–²';
            });
        }

        async function loadPrices() {
            try {
                // Search by ARTIST ONLY to get all their albums from retailers
                console.log('ðŸ” Searching for artist:', artistName);
                
                const response = await fetch(`/api/hybrid-search?q=${encodeURIComponent(artistName)}`);
                
                if (!response.ok) throw new Error('Failed to load prices');

                const results = await response.json();
                console.log('ðŸ“¦ Hybrid search returned:', results.length, 'results for', artistName);
                
                // Filter to find THIS specific album
                const matchingAlbums = results.filter(r => {
                    const artistMatch = r.artist.toLowerCase() === artistName.toLowerCase();
                    if (!artistMatch) return false;
                    
                    const albumLower = r.album.toLowerCase();
                    const titleLower = albumData.title.toLowerCase();
                    
                    // Remove common words for better matching
                    const cleanAlbum = albumLower.replace(/\b(the|a|an)\b/g, '').trim();
                    const cleanTitle = titleLower.replace(/\b(the|a|an)\b/g, '').trim();
                    
                    // Match if one contains the other (handles variants like "Life Of A Showgirl" vs "The Life of a Showgirl")
                    return cleanAlbum.includes(cleanTitle) || cleanTitle.includes(cleanAlbum);
                });
                
                console.log('ðŸŽ¯ Found', matchingAlbums.length, 'matching albums');
                
                if (matchingAlbums.length > 0) {
                    console.log('Matches:', matchingAlbums.map(m => m.album));
                    
                    // Combine all buy options from matching albums
                    const allBuyOptions = [];
                    matchingAlbums.forEach(album => {
                        if (album.buyOptions) {
                            allBuyOptions.push(...album.buyOptions);
                        }
                    });
                    
                    if (allBuyOptions.length > 0) {
                        console.log('âœ… Found', allBuyOptions.length, 'buy options');
                        displayBuyOptions(allBuyOptions);
                    } else {
                        console.log('âŒ No buy options found - showing store links only');
                    }
                } else {
                    console.log('âŒ No matching albums found - showing store links only');
                }

            } catch (error) {
                console.error('Error loading prices:', error);
            }
        }

        function displayBuyOptions(options) {
            const container = document.getElementById('buy-options');
            
            // Sort by price
            options.sort((a, b) => a.price - b.price);

            container.innerHTML = options.map(opt => `
                <a href="${opt.link}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="block py-4 px-6 rounded-lg transition-all hover:shadow-lg bg-white shadow-sm border border-gray-100">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <img src="https://www.google.com/s2/favicons?domain=${opt.source === 'popstore' ? 'wearepopstore.com' : opt.source === 'vinylcastle' ? 'vinylcastle.co.uk' : opt.source === 'emp' ? 'emp.co.uk' : 'example.com'}&sz=64" 
                                 alt="${opt.storeName}" 
                                 style="width: 32px; height: 32px; flex-shrink: 0;">
                            <span style="font-weight: 600; color: #1F2937;">${opt.storeName}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-weight: 700; color: #FF6B6B; font-size: 1.5rem;">Â£${opt.price.toFixed(2)}</span>
                            ${opt.availability === 'In Stock' ? '<span style="color: #10b981; font-size: 0.875rem; font-weight: 500;">âœ“ In Stock</span>' : ''}
                        </div>
                    </div>
                </a>
            `).join('');
        }

        async function loadDiscogsRating(artist, album, mbid) {
            try {
                const res = await fetch(`/api/discogs-rating?artist=${encodeURIComponent(artist)}&album=${encodeURIComponent(album)}&mbid=${encodeURIComponent(mbid || "")}`);
                if (!res.ok) return;
                const data = await res.json();

                const fullStars = Math.floor(data.rating);
                const halfStar = (data.rating % 1) >= 0.5 ? 'Â½' : '';
                const stars = 'â˜…'.repeat(fullStars) + halfStar;

                document.getElementById('discogs-rating').textContent = data.rating.toFixed(1) + ' / 5';
                document.getElementById('discogs-stars').textContent = stars;
                document.getElementById('discogs-count').textContent = data.count.toLocaleString() + ' ratings';
                document.getElementById('discogs-have').textContent = data.have?.toLocaleString() || 'â€”';
                document.getElementById('discogs-want').textContent = data.want?.toLocaleString() || 'â€”';
                document.getElementById('discogs-section').classList.remove('hidden');

            } catch(e) {
                console.error('Discogs rating error:', e);
            }
        }

        async function loadTracklist(releaseId) {
            try {
                const response = await fetch(
                    `https://musicbrainz.org/ws/2/release/${releaseId}?inc=recordings&fmt=json`,
                    { headers: { 'User-Agent': 'findyl/1.0 (https://findyl.co.uk)' } }
                );

                if (!response.ok) return;

                const release = await response.json();
                const tracks = [];

                // Extract all tracks from all media
                if (release.media) {
                    release.media.forEach(medium => {
                        if (medium.tracks) {
                            medium.tracks.forEach(track => {
                                tracks.push({
                                    position: track.position,
                                    title: track.title,
                                    length: track.length
                                });
                            });
                        }
                    });
                }

                if (tracks.length > 0) {
                    displayTracklist(tracks);
                } else {
                    document.getElementById('tracklist-section').classList.add('hidden');
                }

            } catch (error) {
                console.error('Error loading tracklist:', error);
                document.getElementById('tracklist-section').classList.add('hidden');
            }
        }

        function displayTracklist(tracks) {
            const container = document.getElementById('tracklist');
            
            container.innerHTML = tracks.map(track => {
                const duration = track.length ? formatDuration(track.length) : '';
                return `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div class="flex gap-3">
                            <span class="text-gray-400 font-mono text-sm w-6">${track.position}</span>
                            <span class="text-gray-900">${track.title}</span>
                        </div>
                        ${duration ? `<span class="text-gray-500 text-sm font-mono">${duration}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Initialize
        loadAlbumData();
    </script>
</body>
</html>
