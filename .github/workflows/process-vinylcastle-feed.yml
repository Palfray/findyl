name: Process VinylCastle Feed

on:
  push:
    paths:
      - 'data/vinylcastle-feed.csv'
  workflow_dispatch:  # Allows manual trigger

jobs:
  process-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Process VinylCastle feed
        run: |
          python3 << 'EOF'
          import csv
          import json
          import re
          
          def extract_artist_album(product_name):
              """Extract artist and album from product name"""
              clean = re.sub(r'\s*\([^)]*vinyl[^)]*\)|\([^)]*rsd[^)]*\)|\([^)]*indie[^)]*\)|\([^)]*exclusive[^)]*\)', '', product_name, flags=re.IGNORECASE)
              clean = clean.strip()
              
              if ' / ' in clean:
                  parts = clean.split(' / ', 1)
                  return parts[0].strip(), parts[1].strip() if len(parts) > 1 else parts[0].strip()
              elif ' - ' in clean and len(clean.split(' - ')) == 2:
                  parts = clean.split(' - ', 1)
                  return parts[0].strip(), parts[1].strip()
              
              return "Various Artists", clean
          
          def is_vinyl_product(product_name, category):
              """Determine if product is a vinyl record"""
              name_lower = product_name.lower()
              category_lower = category.lower()
              combined = f"{name_lower} {category_lower}"
              
              has_vinyl = ('vinyl' in combined or 
                           'cassettes & vinyl' in category_lower or
                           'lp' in name_lower or
                           '12"' in name_lower)
              
              is_cd = category_lower in ['cd', 'cds']
              is_single = ('7"' in name_lower or 
                           '7 inch' in name_lower or
                           'single' in name_lower)
              
              return has_vinyl and not is_cd and not is_single
          
          print("ðŸ“€ Processing VinylCastle feed...")
          products = []
          
          with open('data/vinylcastle-feed.csv', 'r', encoding='utf-8', errors='ignore') as f:
              reader = csv.DictReader(f)
              
              total_rows = 0
              vinyl_count = 0
              
              for row in reader:
                  total_rows += 1
                  
                  product_name = row.get('product_name', '').strip()
                  if not product_name:
                      continue
                  
                  category = row.get('merchant_category', '').strip()
                  
                  if not is_vinyl_product(product_name, category):
                      continue
                  
                  vinyl_count += 1
                  
                  try:
                      price = float(row.get('search_price', '0').strip())
                      if price <= 0:
                          continue
                  except (ValueError, TypeError):
                      continue
                  
                  affiliate_link = row.get('aw_deep_link', '').strip()
                  if not affiliate_link:
                      continue
                  
                  image = row.get('aw_image_url', '').strip()
                  if not image or 'noimage' in image.lower():
                      image = 'https://via.placeholder.com/300x300?text=Vinyl+Record'
                  
                  artist, album = extract_artist_album(product_name)
                  
                  product = {
                      'artist': artist,
                      'album': album,
                      'price': price,
                      'currency': 'GBP',
                      'link': affiliate_link,
                      'image': image,
                      'availability': 'In Stock'
                  }
                  
                  products.append(product)
                  
                  if len(products) % 100 == 0:
                      print(f"  Found {len(products)} vinyl records...")
          
          print(f"\nðŸ“Š Processing Summary:")
          print(f"  Total rows: {total_rows:,}")
          print(f"  Vinyl found: {vinyl_count:,}")
          print(f"  âœ… Final records: {len(products):,}")
          
          with open('api/vinylcastle-products.json', 'w', encoding='utf-8') as out:
              json.dump(products, out, indent=2, ensure_ascii=False)
          
          print(f"\nâœ… Created api/vinylcastle-products.json")
          
          if products:
              print(f"\nðŸŽµ Sample products:")
              for i, p in enumerate(products[:5], 1):
                  print(f"  {i}. {p['artist']} - {p['album']} (Â£{p['price']:.2f})")
          
          EOF
      
      - name: Commit processed JSON
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add api/vinylcastle-products.json
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸŽµ Update VinylCastle product feed"
          git push
